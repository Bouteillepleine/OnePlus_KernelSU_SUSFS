name: 'Build OnePlus Kernel with KernelSU Next'

inputs:
  op_config_json:
    description: 'JSON string containing full device config'
    required: true
    type: string

  ksu_type:
    description: 'Select KSU Type'
    required: true
    type: choice
    options:
      - KSUN
      - KSU
      - SUKISU

  ksu_branch_or_hash:
    description: 'KSU branch or commit hash (empty = auto-detect by ksu_type)'
    required: false
    type: string
    default: ""

  ksu_meta:
    description: 'SukiSU Ultra metadata in format: branch/custom_tag/commit_hash'
    required: false
    type: string
    default: 'main/âš¡Ultraâš¡/'

  susfs_commit_hash_or_branch:
    description: 'SUSFS branch or commit hash (empty = auto-detect by kernel version)'
    required: false
    type: string
    default: ""

  optimize_level:
    description: 'Compiler optimization level (O2 or O3)'
    required: false
    type: string
    default: O2

  clean:
    description: 'Force clean build without ccache acceleration'
    required: false
    type: string
    default: 'false'

outputs:
  kernel_version:
    description: 'Full kernel version string'
    value: ${{ steps.save_metadata.outputs.kernel_version }}
  ksu_version:
    description: 'KernelSU version number'
    value: ${{ steps.save_metadata.outputs.ksu_version }}
  ksu_type:
    description: 'KernelSU Variant'
    value: ${{ steps.save_metadata.outputs.ksu_type }}
  susfs_version:
    description: 'SUSFS version string'
    value: ${{ steps.save_metadata.outputs.susfs_version }}
  image_sha256:
    description: 'SHA256 hash of kernel Image'
    value: ${{ steps.collect_stats.outputs.image_sha256 }}
  warnings:
    description: 'Number of compiler warnings'
    value: ${{ steps.collect_stats.outputs.warnings_count }}
  build_time:
    description: 'Total build time in seconds'
    value: ${{ steps.collect_stats.outputs.build_time }}
  ccache_hit_rate:
    description: 'ccache hit rate percentage'
    value: ${{ steps.ccache_stats.outputs.hit_rate }}
  ccache_direct_rate:
    description: 'ccache direct hit rate percentage'
    value: ${{ steps.ccache_stats.outputs.direct_rate }}
  zip_name:
    description: 'Name of the generated flashable ZIP'
    value: ${{ steps.create_zip.outputs.zip_name }}

runs:
  using: 'composite'
  steps:
    - name: Parse op_config_json
      shell: bash
      run: |
        set -euo pipefail
        echo '${{ inputs.op_config_json }}' > /tmp/config.json
        jq -r 'to_entries[] | "OP_\(.key | ascii_upcase)=\(.value)"' /tmp/config.json >> "$GITHUB_ENV"
        echo "Parsed config:"
        jq '.' /tmp/config.json

    - name: Validate Inputs
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Validate inputs"
        model="$OP_MODEL"
        soc="$OP_SOC"
        branch="$OP_BRANCH"
        manifest="$OP_MANIFEST"
        android_version="$OP_ANDROID_VERSION"
        kernel_version="$OP_KERNEL_VERSION"
        os_version="$OP_OS_VERSION"
        hmbird="$OP_HMBIRD"
        susfs="$OP_SUSFS"
        bbg="$OP_BBG"
        bbr="$OP_BBR"
        ttl="$OP_TTL"
        ip_set="$OP_IP_SET"
        rust_build="$OP_RUST_BUILD"
        lto="$OP_LTO"
        uname="$OP_UNAME"
        optimize='${{ inputs.optimize_level }}'

        errors=()

        if [[ -z "$model" ]]; then
          errors+=("Input 'model' cannot be empty")
        elif [[ ! "$model" =~ ^OP ]]; then
          errors+=("Input 'model' does not start with 'OP'. Got: '$model'")
        fi

        if [[ -z "$soc" ]]; then
          errors+=("Input 'soc' cannot be empty")
        elif [[ ! "$soc" =~ ^[A-Za-z0-9_-]+$ ]]; then
          errors+=("Input 'soc' contains invalid characters. Allowed: letters, digits, underscore, dash. Got: '$soc'")
        fi

        if [[ -z "$branch" ]]; then
          errors+=("Input 'branch' cannot be empty")
        elif [[ ! "$branch" =~ ^[A-Za-z0-9._/-]+$ ]]; then
          errors+=("Input 'branch' contains invalid characters. Allowed: letters, digits, ., _, -, /. Got: '$branch'")
        fi

        if [[ -z "$manifest" ]]; then
          errors+=("Input 'manifest' cannot be empty")
        elif [[ "$manifest" == http*://* ]]; then
          if [[ ! "$manifest" =~ ^https:// ]]; then
            errors+=("Manifest URL must be HTTPS. Got: '$manifest'")
          fi
          if [[ ! "$manifest" =~ \.xml($|\?) ]]; then
            errors+=("Manifest URL should point to an XML file (.xml). Got: '$manifest'")
          fi
        else
          if [[ ! "$manifest" =~ \.xml$ ]]; then
            errors+=("Manifest filename must end with .xml. Got: '$manifest'")
          fi
          if [[ "$manifest" =~ [[:space:]] ]]; then
            errors+=("Manifest filename cannot contain spaces. Got: '$manifest'")
          fi
        fi

        if [[ -z "$android_version" ]]; then
          errors+=("Input 'android_version' cannot be empty")
        elif [[ ! "$android_version" =~ ^android[0-9]+$ ]]; then
          errors+=("Input 'android_version' contains invalid characters. Allowed: android followed by a number. Got: '$android_version'")
        fi

        if [[ -z "$kernel_version" ]]; then
          errors+=("Input 'kernel_version' cannot be empty")
        elif [[ ! "$kernel_version" =~ ^[0-9]+\.[0-9]+$ ]]; then
          errors+=("Input 'kernel_version' contains invalid characters. Allowed: number in X.Y format. Got: '$kernel_version'")
        fi

        if [[ -z "$os_version" ]]; then
          errors+=("Input 'os_version' cannot be empty")
        elif [[ ! "$os_version" =~ ^OOS ]]; then
          errors+=("Input 'os_version' does not start with 'OOS'. Got: '$os_version'")
        fi

        for b in hmbird susfs bbg bbr ttl ip_set rust_build; do
          v="${!b}"
          if [[ -z "$v" ]]; then
            errors+=("Input '$b' cannot be empty")
          elif [[ "$v" != "true" && "$v" != "false" ]]; then
            errors+=("Input '$b' must be 'true' or 'false'. Got: '$v'")
          fi
        done

        if [[ -z "$lto" ]]; then
          errors+=("Input 'lto' cannot be empty")
        elif [[ "$lto" != "none" && "$lto" != "thin" && "$lto" != "full" ]]; then
          errors+=("Input 'lto' contains invalid characters. Allowed: 'thin', 'full' or 'none'. Got: '$lto'")
        fi

        if [[ -z "$uname" ]]; then
          errors+=("Input 'uname' cannot be empty")
        elif [[ ${#uname} -gt 44 ]]; then
          errors+=("Input 'uname' too long. Maximum length: 44. Got: '$uname'")
        fi

        case "$optimize" in
          O2|O3) ;;
          *) errors+=("optimize_level must be O2 or O3. Got: '$optimize'"); ;;
        esac

        if [ ${#errors[@]} -ne 0 ]; then
          echo "Found ${#errors[@]} validation error(s):" >&2
          for error in "${errors[@]}"; do
            echo "  - $error" >&2
          done
          echo "::error::Input validation failed. See logs for details."
          exit 1
        else
          echo "âœ… Input validation passed"
        fi
        echo "::endgroup::"

    - name: Install bindgen only (no rustc)
      shell: bash
      if: ${{ env.OP_RUST_BUILD == 'true' }}
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain none
        source $HOME/.cargo/env
        cargo install bindgen-cli --version 0.69.5
        bindgen --version
        which bindgen

    - name: Show bindgen version
      shell: bash
      if: ${{ env.OP_RUST_BUILD == 'true' }}
      run: bindgen --version

    - name: Setup Base Environment
      shell: bash
      run: |
        set -euo pipefail
        CONFIG="$OP_MODEL"
        echo "CONFIG=$CONFIG" >> "$GITHUB_ENV"
        REPO="/usr/local/bin/repo"
        if [ ! -x "$REPO" ]; then
          curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
          chmod +x "$REPO"
        fi
        echo "REPO=$REPO" >> "$GITHUB_ENV"

    - name: Optimize Global Git for Repo Tool
      shell: bash
      run: |
        set -euo pipefail
        git config --global feature.manyFiles true
        git config --global core.fsmonitor true
        git config --global pack.sparse true

    - name: Initialize and Sync Kernel Source
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Initialize kernel source"
        echo "Creating folder for configuration: $CONFIG"
        mkdir -p "$CONFIG"
        cd "$CONFIG"
        echo "Initializing and syncing kernel source..."

        if [[ "$OP_MANIFEST" == https://* ]]; then
          mkdir -p .repo/manifests
          curl --fail --show-error --location --proto '=https' "$OP_MANIFEST" -o .repo/manifests/temp_manifest.xml
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git -b "oneplus/sm8650" -m temp_manifest.xml --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        elif [[ "$OP_BRANCH" == wild/* ]]; then
          mkdir -p .repo/manifests
          cp "../manifests/$(echo "$OP_OS_VERSION" | tr '[:upper:]' '[:lower:]')/$OP_MANIFEST" .repo/manifests/temp_manifest.xml
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git -b "oneplus/sm8650" -m temp_manifest.xml --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        else
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git -b "$OP_BRANCH" -m "$OP_MANIFEST" --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        fi

        "$REPO" --version
        success=false
        for i in 1 2 3; do
          if "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch \
             -j"$(nproc --all)" --fail-fast; then
            success=true
            break
          fi
          echo "âš ï¸ repo sync attempt $i failed; retrying..."
          sleep 30
        done
        $success || { echo "::error::repo sync failed after 3 attempts"; exit 1; }
        echo "âœ… Kernel source synced"
        echo "::endgroup::"

    - name: Set Dir Paths
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        KERNEL_PLATFORM_DIR="$CONFIG_DIR/kernel_platform"
        COMMON_KERNEL_DIR="$KERNEL_PLATFORM_DIR/common"
        MSM_KERNEL_DIR="$KERNEL_PLATFORM_DIR/msm-kernel"
        AK3_DIR="$GITHUB_WORKSPACE/AnyKernel3"
        KERNEL_PATCHES_DIR="$GITHUB_WORKSPACE/kernel_patches"
        SUSFS_DIR="$GITHUB_WORKSPACE/susfs4ksu"
        KSU_DIR="$KERNEL_PLATFORM_DIR/KernelSU"
        KSUN_DIR="$KERNEL_PLATFORM_DIR/KernelSU-Next"
        mkdir -p "$ARTIFACTS_DIR"

        echo "CONFIG_FOLDER=$CONFIG_DIR" >> "$GITHUB_ENV"
        echo "ARTIFACTS_FOLDER=$ARTIFACTS_DIR" >> "$GITHUB_ENV"
        echo "KERNEL_PLATFORM_FOLDER=$KERNEL_PLATFORM_DIR" >> "$GITHUB_ENV"
        echo "COMMON_KERNEL_FOLDER=$COMMON_KERNEL_DIR" >> "$GITHUB_ENV"
        echo "MSM_KERNEL_FOLDER=$MSM_KERNEL_DIR" >> "$GITHUB_ENV"
        echo "AK3_FOLDER=$AK3_DIR" >> "$GITHUB_ENV"
        echo "KERNEL_PATCHES_FOLDER=$KERNEL_PATCHES_DIR" >> "$GITHUB_ENV"
        echo "SUSFS_FOLDER=$SUSFS_DIR" >> "$GITHUB_ENV"
        echo "KSU_FOLDER=$KSU_DIR" >> "$GITHUB_ENV"
        echo "KSUN_FOLDER=$KSUN_DIR" >> "$GITHUB_ENV"

    - name: Get Kernel Version Info
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Get kernel version"
        cd "$COMMON_KERNEL_FOLDER"

        CONFIG_FILES=("build.config.common" "build.config.constants")
        BRANCH_LINE=""
        for f in "${CONFIG_FILES[@]}"; do
          if [ -f "$f" ]; then
            l=$(grep '^[[:space:]]*BRANCH=' "$f" || true)
            if [ -n "$l" ]; then BRANCH_LINE="$l"; break; fi
          fi
        done

        if [ -z "$BRANCH_LINE" ]; then
          echo "::error::No BRANCH= found in config files"; exit 1
        fi

        BRANCH_VALUE="${BRANCH_LINE#*=}"
        ANDROID_VERSION="${BRANCH_VALUE%-*}"

        if [ -z "$ANDROID_VERSION" ]; then
          echo "::error::Could not parse android version from BRANCH=$BRANCH_VALUE"
          exit 1
        fi

        VERSION=$(grep '^VERSION *=' Makefile | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL *=' Makefile | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | awk '{print $3}')
        FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"

        cd "$ARTIFACTS_FOLDER"
        echo "$ANDROID_VERSION-$FULL_VERSION" > "${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "$OP_OS_VERSION" >> "${OP_MODEL}_${OP_OS_VERSION}.txt"

        {
          echo "ANDROID_VER=$ANDROID_VERSION"
          echo "KERNEL_VER=$VERSION.$PATCHLEVEL"
          echo "TKERNEL_VER=$FULL_VERSION"
          echo "KERNEL_FULL_VER=$ANDROID_VERSION-$FULL_VERSION"
          if [ "${{ env.OP_SUSFS }}" = true ]; then
            echo "SUSFS_KERNEL_BRANCH=gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL"
          fi
        } >> "$GITHUB_ENV"

        echo "âœ… Detected: $ANDROID_VERSION-$FULL_VERSION"
        if [ "${{ env.OP_SUSFS }}" = true ]; then
          echo "   SUSFS Branch: gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL"
        fi
        echo "::endgroup::"

    - name: ðŸ·ï¸ Set Build Identity (Hardcoded)
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Set build user/host"
        BUILD_USER="OnePlus"
        BUILD_HOST="ubuntu-build"
        echo "BUILD_USER=$BUILD_USER" >> "$GITHUB_ENV"
        echo "BUILD_HOST=$BUILD_HOST" >> "$GITHUB_ENV"
        echo "::endgroup::"

    - name: Detect Clang and Rust
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Detect Clang"
        CLANG_FOUND=false
        RUSTC_FOUND=false
        for base in "$KERNEL_PLATFORM_FOLDER/prebuilts" "$KERNEL_PLATFORM_FOLDER/prebuilts-master"; do
          [ -d "$base/clang/host/linux-x86" ] || continue
          latest=$(ls -d "$base"/clang/host/linux-x86/clang-r*/ 2>/dev/null | sort -V | tail -n1 || true)
          if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
            CLANG_BIN="$latest/bin"
            CLANG_FOUND=true
            break
          fi
        done
        for base in "$KERNEL_PLATFORM_FOLDER/prebuilts" "$KERNEL_PLATFORM_FOLDER/prebuilts-master"; do
          [ -d "$base/rust/linux-x86/" ] || continue
          ls -la "$base/rust/linux-x86/"
          latest=$(ls -d "$base/rust/linux-x86/1."* 2>/dev/null | sort -V | head -n1 || true)
          if [ -n "$latest" ] && [ -x "$latest/bin/rustc" ]; then
            RUSTC_BIN="$latest/bin"
            RUSTC_FOUND=true
            break
          fi
        done
        if ! $CLANG_FOUND && command -v clang >/dev/null 2>&1; then
          CLANG_BIN="$(dirname "$(command -v clang)")"
          CLANG_FOUND=true
          echo "Using system clang."
        fi
        $CLANG_FOUND || { echo "::error::No clang toolchain found"; exit 1; }
        $RUSTC_FOUND || { echo "::warning::No RUST toolchain found! Ignoring";}
        echo "CLANG_BIN_PATH=$CLANG_BIN" >> "$GITHUB_ENV"
        if [ "$RUSTC_FOUND" = true ]; then
          echo "RUSTC_BIN_PATH=$RUSTC_BIN" >> "$GITHUB_ENV"
          RUSTC_VERSION="$("$RUSTC_BIN/rustc" --version | head -n1)"
          echo "RUSTC_VERSION=$RUSTC_VERSION" >> "$GITHUB_ENV"
          echo "âœ… Detected RUSTC: $RUSTC_VERSION"
        fi
        CLANG_VERSION="$("$CLANG_BIN/clang" --version | head -n1)"
        echo "CLANG_VERSION=$CLANG_VERSION" >> "$GITHUB_ENV"
        echo "âœ… Detected Clang: $CLANG_VERSION"
        echo "::endgroup::"

    - name: Derive Clang Short Version
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Derive Clang fingerprint"
        short="$("${CLANG_BIN_PATH}/clang" --version | sed -n '1s/.*clang-r\([0-9.]\+\).*/\1/p')"
        if [ -z "$short" ]; then
          short="$("${CLANG_BIN_PATH}/clang" --version | sha256sum | cut -c1-8)"
          echo "âš ï¸ Could not extract clang-r version, using hash: $short"
        else
          echo "âœ… Clang version fingerprint: $short"
        fi
        echo "CLANG_VERSION_SHORT=$short" >> "$GITHUB_ENV"
        CLANG_FULL_VERSION="$("${CLANG_BIN_PATH}/clang" --version | head -n1)"
        echo "CLANG_FULL_VERSION=$CLANG_FULL_VERSION" >> "$GITHUB_ENV"
        echo "::endgroup::"

    - name: Set Cache Environment
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Configure ccache environment"
        CACHE_DIR="$HOME/.ccache"
        echo "CCACHE_DIR=$CACHE_DIR" >> "$GITHUB_ENV"
        echo "CCACHE_MAXSIZE=1G" >> "$GITHUB_ENV"
        mkdir -p "$CACHE_DIR"
        echo "::endgroup::"

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-ksun-v3-${{ env.OP_MODEL }}-${{ env.OP_OS_VERSION }}-${{ env.KERNEL_FULL_VER }}-${{ env.CLANG_VERSION_SHORT }}
        restore-keys: |
          ccache-ksun-v3-${{ env.OP_MODEL }}-${{ env.OP_OS_VERSION }}-${{ env.KERNEL_FULL_VER }}-
          ccache-ksun-v3-${{ env.OP_MODEL }}-${{ env.OP_OS_VERSION }}-

    - name: Configure ccache
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Configure ccache for maximum performance"
        export CCACHE_DIR="$HOME/.ccache"
        export CCACHE_MAXSIZE="1G"
        ccache -M "$CCACHE_MAXSIZE"
        export CCACHE_COMPILERCHECK="content"
        export CCACHE_BASEDIR="${GITHUB_WORKSPACE}"
        export CCACHE_NOHASHDIR="true"
        ccache -o compression=true
        ccache -o compression_level=3
        ccache -o direct_mode=true
        ccache -o hash_dir=false
        ccache -o file_clone=true
        ccache -o inode_cache=true
        ccache -o umask=002
        if ccache --help 2>&1 | grep -q 'depend_mode'; then
          ccache -o depend_mode=true
        fi
        ccache -o sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime,pch_defines,system_headers,locale
        export CCACHE_IGNOREOPTIONS="--sysroot*"
        {
          echo "CCACHE_COMPILERCHECK=content"
          echo "CCACHE_BASEDIR=${GITHUB_WORKSPACE}"
          echo "CCACHE_NOHASHDIR=true"
          echo "CCACHE_IGNOREOPTIONS=$CCACHE_IGNOREOPTIONS"
        } >> "$GITHUB_ENV"
        echo "::endgroup::"

    - name: Handle Clean Build Option
      if: ${{ inputs.clean == 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Clean build requested"
        echo "CCACHE_DISABLE=1" >> "$GITHUB_ENV"
        echo "::endgroup::"

    - name: Clone AnyKernel3 and Other Dependencies (with SUSFS pin)
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Clone dependencies"
        echo "Cloning AnyKernel3 and other dependencies..."
    
        ANYKERNEL_BRANCH="gki-2.0"
    
        retry_clone() {
          local url="$1"
          local branch="${2:-main}"
          local depth="${3:-1}"
          local dir
          dir="$(basename "$url" .git)"
          local max_attempts=3
          local attempt=1
          local clone_args=(--branch "$branch")
          if [ "$depth" != "0" ] && [ -n "$depth" ]; then
            clone_args+=(--depth "$depth")
          fi
    
          while [ $attempt -le $max_attempts ]; do
            echo "ðŸ”„ Attempt $attempt/$max_attempts: cloning $url ($branch)${depth:+ [depth=$depth]}"
            git clone "${clone_args[@]}" "$url" "$dir" && { echo "âœ… Success"; return 0; }
            echo "âŒ Failed, cleaning up..."
            rm -rf "$dir" 2>/dev/null || true
            sleep $((attempt++ * 5))
          done
    
          echo "ðŸ’¥ All attempts failed"
          return 1
        }
    
        retry_clone "https://github.com/TheWildJames/AnyKernel3.git" "$ANYKERNEL_BRANCH"
        retry_clone "https://github.com/TheWildJames/kernel_patches.git"
    
        # Needed for SUKISU hide patches
        if [ "${{ inputs.ksu_type }}" = "SUKISU" ]; then
          retry_clone "https://github.com/ShirkNeko/SukiSU_patch.git" "main" 1
        fi
    
        # SUSFS (only if device config enables it)
        if [ "${{ env.OP_SUSFS }}" = "true" ]; then
          SUSFS_INPUT="${{ inputs.susfs_commit_hash_or_branch }}"
    
          declare -A DEFAULT_SUSFS=(
            ["android12-5.10"]="gki-android12-5.10"
            ["android13-5.15"]="gki-android13-5.15"
            ["android14-6.1"]="gki-android14-6.1"
            ["android15-6.6"]="gki-android15-6.6"
            ["android16-6.12"]="gki-android16-6.12"
          )
    
          KERNEL_KEY="${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}"
    
          # If input empty or "next", use default branch for this kernel line
          if [ -z "${SUSFS_INPUT:-}" ] || [ "${SUSFS_INPUT}" = "next" ]; then
            SUSFS_REF="${DEFAULT_SUSFS[$KERNEL_KEY]:-gki-android15-6.6}"
            echo "â„¹ï¸  Using default SUSFS ref for $KERNEL_KEY: $SUSFS_REF"
          else
            SUSFS_REF="$SUSFS_INPUT"
            echo "ðŸ”§ Using custom SUSFS ref: $SUSFS_REF"
          fi
    
          # Clone full (depth=0) so commits/tags/branches are available
          retry_clone "https://gitlab.com/simonpunk/susfs4ksu.git" "master" 0
          cd susfs4ksu
    
          # Checkout branch or commit/tag
          if git rev-parse --verify "origin/$SUSFS_REF" >/dev/null 2>&1; then
            git checkout -f "$SUSFS_REF"
          elif git rev-parse --verify "$SUSFS_REF" >/dev/null 2>&1; then
            git checkout -f "$SUSFS_REF"
          else
            echo "::error::SUSFS ref '$SUSFS_REF' not found"
            echo "Remote branches (first 30):"
            git branch -r | head -n 30
            exit 1
          fi
    
          SUSFS_COMMIT_SHA="$(git rev-parse HEAD)"
          SUSFS_BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo detached)"
          echo "SUSFS_COMMIT_SHA=$SUSFS_COMMIT_SHA" >> "$GITHUB_ENV"
          echo "SUSFS_BRANCH_NAME=$SUSFS_BRANCH_NAME" >> "$GITHUB_ENV"
          echo "âœ… SUSFS pinned: $SUSFS_BRANCH_NAME @ $SUSFS_COMMIT_SHA"
    
          cd ..
        fi
    
        echo "âœ… Dependencies cloned"
        echo "::endgroup::"

    - name: Clean Up ABI Protected Exports
      shell: bash
      run: |
        set -euo pipefail
        cd "$KERNEL_PLATFORM_FOLDER"
        rm -f common/android/abi_gki_protected_exports_* || true
        rm -f msm-kernel/android/abi_gki_protected_exports_* || true
        sed -i 's/protected_modules = \[.*\]/protected_modules = []/' common/modules.bzl || true
        df -h

    - name: Add KernelSU Next
      shell: bash
      if: ${{ inputs.ksu_type == 'KSUN' }}
      run: |
        set -euo pipefail
        echo "::group::Add KernelSU Next"
        cd "$KERNEL_PLATFORM_FOLDER"
        echo "Adding KernelSU Next..."
        if [ "${{ inputs.ksu_branch_or_hash }}" = "" ]; then
          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
        else
          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s "${{ inputs.ksu_branch_or_hash }}"
        fi
        git submodule update --init --recursive
        cd KernelSU-Next/kernel

        COMMITS_COUNT=$(/usr/bin/git rev-list --count HEAD)
        if [ $COMMITS_COUNT -lt 2684 ]; then BASE_VERSION=10200; else BASE_VERSION=30000; fi
        KSU_VERSION=$(expr $COMMITS_COUNT "+" $BASE_VERSION)
        sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile

        if [ "$KSU_VERSION" -lt 12884 ]; then echo "NEED_HOOKS=true" >> $GITHUB_ENV; else echo "NEED_HOOKS=false" >> $GITHUB_ENV; fi

        cd ..
        KSU_COMMIT_SHA=$(git rev-parse HEAD)
        echo "KSU_COMMIT_SHA=$KSU_COMMIT_SHA" >> $GITHUB_ENV
        echo "KSUN" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "$KSU_VERSION" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
        echo "::endgroup::"

    - name: Add KernelSU
      shell: bash
      if: ${{ inputs.ksu_type == 'KSU' }}
      run: |
        set -euo pipefail
        echo "::group::Add KernelSU"
        cd "$KERNEL_PLATFORM_FOLDER"
        echo "Adding KernelSU..."
        if [ "${{ inputs.ksu_branch_or_hash }}" = "" ]; then
          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
        else
          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s "${{ inputs.ksu_branch_or_hash }}"
        fi
        git submodule update --init --recursive
        cd KernelSU/kernel
        BASE_VERSION=20000
        KSU_VERSION=$(expr $(/usr/bin/git rev-list --count HEAD) "+" $BASE_VERSION)
        sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" Makefile

        echo "NEED_HOOKS=false" >> $GITHUB_ENV

        cd ..
        KSU_COMMIT_SHA=$(git rev-parse HEAD)
        echo "KSU_COMMIT_SHA=$KSU_COMMIT_SHA" >> $GITHUB_ENV
        echo "KSU" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "$KSU_VERSION" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
        echo "::endgroup::"

    - name: Add SukiSU Ultra
      shell: bash
      if: ${{ inputs.ksu_type == 'SUKISU' }}
      run: |
        set -euo pipefail
        echo "::group::Add SukiSU Ultra"
        cd "$KERNEL_PLATFORM_FOLDER"

        META="${{ inputs.ksu_meta }}"
        if [[ "$(grep -o '/' <<< "$META" | wc -l)" -lt 2 ]]; then
          echo "::error::Invalid 'ksu_meta' format. Expected: branch/custom_tag/commit_hash"
          echo "Example: builtin/Numbersf/"
          exit 1
        fi

        IFS='/' read -r BRANCH_NAME CUSTOM_TAG MANUAL_HASH <<< "$META"
        echo "Branch: $BRANCH_NAME"
        echo "Custom Tag: ${CUSTOM_TAG:-Not set}"
        echo "Manual Commit: ${MANUAL_HASH:-Not set}"

        # Install SukiSU into kernel_platform/KernelSU
        curl -fsSL --retry 3 --connect-timeout 30 \
          "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH_NAME"

        cd "./KernelSU"

        # Pin to manual commit if provided
        if [[ -n "${MANUAL_HASH:-}" ]]; then
          git fetch origin "$BRANCH_NAME" --depth=50
          git checkout "$MANUAL_HASH"
          SHORT_HASH="${MANUAL_HASH:0:8}"
        fi

        # Record exact commit
        KSU_COMMIT_SHA="$(git rev-parse HEAD)"
        echo "KSU_COMMIT_SHA=$KSU_COMMIT_SHA" >> "$GITHUB_ENV"

        # Patch sulog include if needed (repo layout differs across commits)
        for cand in "./kernel/sulog.c" "./drivers/kernelsu/sulog.c"; do
          if [ -f "$cand" ] && ! grep -q '#include <linux/version.h>' "$cand"; then
            sed -i '0,/^#include/s|^\(#include.*\)$|\1\n#include <linux/version.h>|' "$cand"
          fi
        done

        # Determine which file holds version defs (Kbuild preferred like the working YAML)
        VERFILE=""
        if [ -f "kernel/Kbuild" ]; then
          VERFILE="kernel/Kbuild"
        elif [ -f "kernel/Makefile" ]; then
          VERFILE="kernel/Makefile"
        else
          echo "::error::Cannot find kernel/Kbuild or kernel/Makefile inside KernelSU checkout"
          exit 1
        fi
        echo "Using version file: $VERFILE"

        # Extract API version (try remote first like the working YAML; fallback to local)
        KSU_API_VERSION="$(curl -fsSL --retry 3 --connect-timeout 30 \
          "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/$BRANCH_NAME/kernel/Kbuild" 2>/dev/null | \
          grep -m1 'KSU_VERSION_API :=' | awk -F':=' '{print $2}' | tr -d '[:space:]' || true)"

        if [[ -z "$KSU_API_VERSION" ]]; then
          KSU_API_VERSION="$(grep -m1 'KSU_VERSION_API :=' "$VERFILE" | awk -F':=' '{print $2}' | tr -d '[:space:]' || true)"
        fi

        # Keep your chosen default here (set to 4.1.0 if you want that behavior)
        if [[ -z "$KSU_API_VERSION" ]]; then
          echo "Warning: Missing API version. Using default: 4.1.0"
          KSU_API_VERSION="4.1.0"
        fi
        echo "KSU_API_VERSION=$KSU_API_VERSION" >> "$GITHUB_ENV"

        # Assemble full version string
        GIT_HASH="$(git rev-parse --short HEAD)"
        if [[ -n "${MANUAL_HASH:-}" ]]; then
          USE_HASH="$SHORT_HASH"
        else
          USE_HASH="$GIT_HASH"
        fi

        if [[ -z "${CUSTOM_TAG:-}" ]]; then
          VERSION_FULL="v$KSU_API_VERSION-$USE_HASH@$BRANCH_NAME"
        else
          VERSION_FULL="v$KSU_API_VERSION-$CUSTOM_TAG@$BRANCH_NAME[$USE_HASH]"
        fi

        # Remove old defs and inject new defs
        sed -i '/define get_ksu_version_full/,/endef/d' "$VERFILE"
        sed -i '/KSU_VERSION_API :=/d' "$VERFILE"
        sed -i '/KSU_VERSION_FULL :=/d' "$VERFILE"
        
        VERSION_DEFINITIONS=$(cat <<EOF
          define get_ksu_version_full
          $VERSION_FULL
          endef

          KSU_VERSION_API := $KSU_API_VERSION
          KSU_VERSION_FULL := $VERSION_FULL
        EOF
        )
        awk -v def="$VERSION_DEFINITIONS" '
          /REPO_OWNER :=/ {print; print def; inserted=1; next}
          1
          END {if (!inserted) print def}
        ' "$VERFILE" > "${VERFILE}.tmp" && mv "${VERFILE}.tmp" "$VERFILE"

        # KSU numeric version (keeping your existing scheme)
        KSU_VERSION="$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 37185)"
        echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"
        echo "NEED_HOOKS=false" >> "$GITHUB_ENV"

        # Write to your metadata artifact file
        echo "SUKISU" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "$KSU_VERSION" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "$KSU_COMMIT_SHA" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"

        echo "::endgroup::"
    
    - name: Apply SUSFS Patches (single, reject-aware)
      shell: bash
      if: ${{ env.OP_SUSFS == 'true' }}
      run: |
        set -euo pipefail
        echo "::group::Apply SUSFS patches"
    
        # 1) Copy SUSFS headers/fs additions
        cp "$SUSFS_FOLDER/kernel_patches/fs/"* "$COMMON_KERNEL_FOLDER/fs/"
        cp "$SUSFS_FOLDER/kernel_patches/include/linux/"* "$COMMON_KERNEL_FOLDER/include/linux/"
    
        SUSFS_VERSION="$(grep '#define SUSFS_VERSION' "$COMMON_KERNEL_FOLDER/include/linux/susfs.h" | awk -F'"' '{print $2}' || true)"
        echo "SUSVER=${SUSFS_VERSION:-unknown}" >> "$GITHUB_ENV"
        echo "${SUSFS_VERSION:-unknown}" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "SusFS Version: ${SUSFS_VERSION:-unknown}"
    
        # 2) Enable SUSFS inside KSU/KSUN (NOT needed for SUKISU in most setups, but harmless if patch exists)
        if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
          cd "$KSUN_FOLDER"
          patch -p1 --forward < "$SUSFS_FOLDER/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" || true
        elif [ "${{ inputs.ksu_type }}" = "KSU" ] || [ "${{ inputs.ksu_type }}" = "SUKISU" ]; then
          cd "$KSU_FOLDER"
          patch -p1 --forward < "$SUSFS_FOLDER/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" || true
        fi
    
        # 3) Apply kernel SUSFS patch (THIS is the dangerous one â†’ must be reject-aware)
        cd "$COMMON_KERNEL_FOLDER"
    
        SUSFS_PATCH="50_add_susfs_in_gki-${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}.patch"
        if [ ! -f "$SUSFS_FOLDER/kernel_patches/$SUSFS_PATCH" ]; then
          echo "::error::Missing SUSFS kernel patch: $SUSFS_PATCH"
          ls -la "$SUSFS_FOLDER/kernel_patches" | head -n 80 || true
          exit 1
        fi
    
        cp "$SUSFS_FOLDER/kernel_patches/$SUSFS_PATCH" ./
    
        # Optional Trusty-missing fix (keep your existing idea)
        KERNEL_VERSION="${{ env.KERNEL_VER }}"
        TKERNEL_VERSION="${{ env.TKERNEL_VER }}"
        TRUSTY_EXISTS="false"
        if [[ "$KERNEL_VERSION" == "6.6" || "$KERNEL_VERSION" == "6.12" ]]; then
          # Your manifests_fallback path isn't guaranteed in this composite; so only try if present
          if [ -n "${OP_MANIFEST:-}" ] && [ -f "$GITHUB_WORKSPACE/$CONFIG/.repo/manifests_fallback/$OP_MANIFEST" ]; then
            if grep -q 'common-modules/trusty' "$GITHUB_WORKSPACE/$CONFIG/.repo/manifests_fallback/$OP_MANIFEST" 2>/dev/null; then
              TRUSTY_EXISTS="true"
            fi
          fi
    
          if [[ "$TRUSTY_EXISTS" == "false" ]]; then
            if [[ "$KERNEL_VERSION" == "6.12" ]] && [[ "$(printf '%s\n' "$TKERNEL_VERSION" "6.12.0" | sort -V | head -n1)" == "$TKERNEL_VERSION" ]]; then
              sed -i 's/-32,12 +32,38/-32,11 +32,37/g' "$SUSFS_PATCH"
              sed -i '/#include <trace\/hooks\/fs.h>/d' "$SUSFS_PATCH"
            fi
            if [[ "$KERNEL_VERSION" == "6.6" ]] && [[ "$(printf '%s\n' "$TKERNEL_VERSION" "6.6.30" | sort -V | head -n1)" == "$TKERNEL_VERSION" ]]; then
              sed -i 's/-32,12 +32,38/-32,11 +32,37/g' "$SUSFS_PATCH"
              sed -i '/#include <trace\/hooks\/fs.h>/d' "$SUSFS_PATCH"
            fi
          fi
        fi
    
        echo "Applying: $SUSFS_PATCH"
        patch -p1 --forward < "$SUSFS_PATCH"
    
        # Fail hard if rejects exist
        if find . -name "*.rej" -o -name "*.orig" | grep -q .; then
          echo "::error::SUSFS patch produced rejects (.rej/.orig)."
          find . -name "*.rej" -o -name "*.orig" -print
          exit 1
        fi
    
        # 4) Record SUSFS commit in your metadata file (if available)
        echo "SUSFS" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "${SUSFS_VERSION:-unknown}" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
        echo "${SUSFS_COMMIT_SHA:-unknown}" >> "${ARTIFACTS_FOLDER}/${OP_MODEL}_${OP_OS_VERSION}.txt"
    
        echo "âœ… SUSFS patches applied cleanly"
        echo "::endgroup::"

    - name: Apply Hide Stuff Patches (SukiSU Ultra, reject-aware)
      shell: bash
      if: ${{ inputs.ksu_type == 'SUKISU' }}
      run: |
        set -euo pipefail
        echo "::group::Apply hide stuff patches"
        COMMON_DIR="$COMMON_KERNEL_FOLDER"
        PATCH_DIR="$GITHUB_WORKSPACE/SukiSU_patch"
    
        cd "$COMMON_DIR"
    
        test -f "$PATCH_DIR/69_hide_stuff.patch" || { echo "::error::Missing $PATCH_DIR/69_hide_stuff.patch"; exit 1; }
    
        cp "$PATCH_DIR/69_hide_stuff.patch" ./
        patch -p1 --forward -F 3 < 69_hide_stuff.patch
    
        if find . -name "*.rej" -o -name "*.orig" | grep -q .; then
          echo "::error::Hide-stuff patch produced rejects (.rej/.orig)."
          find . -name "*.rej" -o -name "*.orig" -print
          exit 1
        fi
    
        echo "âœ… Hide stuff applied cleanly"
        echo "::endgroup::"

    - name: Add KSU / KSUN and SUSFS Configuration Settings
      shell: bash
      run: |
        set -euo pipefail
        cat >> "$COMMON_KERNEL_FOLDER/arch/arm64/configs/gki_defconfig" <<EOF
        CONFIG_KSU=y
        CONFIG_KSU_KPROBES_HOOK=n
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_KSU_SUSFS_SUS_MAP=y
        CONFIG_KSU_SUSFS_SUS_SU=n
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        EOF

    - name: Save Build Metadata
      id: save_metadata
      shell: bash
      run: |
        set -euo pipefail
        echo "kernel_version=${{ env.KERNEL_FULL_VER }}" >> "$GITHUB_OUTPUT"
        echo "ksu_version=${KSUVER:-unknown}" >> "$GITHUB_OUTPUT"
        echo "ksu_type=${{ inputs.ksu_type }}" >> "$GITHUB_OUTPUT"
        if [ "${{ env.OP_SUSFS }}" = true ]; then
          echo "susfs_version=${SUSVER:-unknown}" >> "$GITHUB_OUTPUT"
        fi

    - name: Customize Kernel Branding
      shell: bash
      run: |
        set -euo pipefail
        echo "Customize Kernel Branding"
        cd "$COMMON_KERNEL_FOLDER"
        mkdir -p out
        CUSTOM_LOCALVERSION="-${ANDROID_VER}-${OP_UNAME}"
        echo "CUSTOM_LOCALVERSION=$CUSTOM_LOCALVERSION" >> "$GITHUB_ENV"

    - name: Disable GPUEB
      shell: bash
      if: ${{ env.KERNEL_VER == '5.10' && (startsWith(env.OP_SOC, 'dimensity') || startsWith(env.OP_SOC, 'helio')) }}
      run: |
        set -euo pipefail
        echo "Disabling GPUEB for MTK kernel 5.10"
        sed -i '/obj-y.*gpueb/d' "$COMMON_KERNEL_FOLDER/drivers/gpu/mediatek/Makefile"

    - name: Build Kernel
      shell: bash
      env:
        PYTHONWARNINGS: "ignore:invalid escape sequence"
      run: |
        set -euo pipefail
        echo "::group::Build kernel with ccache optimization"
        
        cd "$COMMON_KERNEL_FOLDER"
        : > "$COMMON_KERNEL_FOLDER/.scmversion"
        
        export PYTHONWARNINGS="${PYTHONWARNINGS}"
        
        echo "Getting last commit timestamp from kernel source..."
        COMMIT_TIMESTAMP=$(git log -1 --format=%ct 2>/dev/null || echo "$(date +%s)")
        COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S' 2>/dev/null || date -u '+%Y-%m-%d %H:%M:%S')
        COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        
        WORKSPACE="${GITHUB_WORKSPACE}"
        MAP="-fdebug-prefix-map=${WORKSPACE}=."
        MPMAP="-fmacro-prefix-map=${WORKSPACE}=."
        FPMAP="-ffile-prefix-map=${WORKSPACE}=."
        
        export KCFLAGS="${KCFLAGS:-} $MAP $MPMAP $FPMAP -no-canonical-prefixes -fdiagnostics-color=never -Qunused-arguments -Wno-unused-command-line-argument -D__ANDROID_COMMON_KERNEL__"
        export KCPPFLAGS="${KCPPFLAGS:-} $MAP $MPMAP $FPMAP"
        
        export LLVM=1 LLVM_IAS=1
        export ARCH=arm64 SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export PAHOLE="$KERNEL_PLATFORM_FOLDER/prebuilts/kernel-build-tools/linux-x86/bin/pahole"
        export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm 
        export OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip
        
        set +u
        source "$KERNEL_PLATFORM_FOLDER/build/kernel/_setup_env.sh" 2>/dev/null || true
        set -u
        
        KERNEL_BUILD_DATE=$(date -u)
        export SOURCE_DATE_EPOCH=$COMMIT_TIMESTAMP
        export KBUILD_BUILD_TIMESTAMP="$KERNEL_BUILD_DATE"
        export KBUILD_BUILD_USER="${BUILD_USER:-kernel}"
        export KBUILD_BUILD_HOST="${BUILD_HOST:-kleaf}"
        export KBUILD_BUILD_VERSION=1
        
        echo "ðŸ“… Build timestamp: $KBUILD_BUILD_TIMESTAMP (from commit $COMMIT_HASH)"
        echo "ðŸ”¢ SOURCE_DATE_EPOCH: $SOURCE_DATE_EPOCH"
        echo "ðŸ‘¤ Build user: $KBUILD_BUILD_USER"
        echo "ðŸ–¥ï¸  Build host: $KBUILD_BUILD_HOST"
        
        export CC="ccache clang"
        export CXX="ccache clang++"
        export HOSTCC="ccache clang"
        export HOSTCXX="ccache clang++"
        
        BASE_PATH="/usr/lib/ccache:${CLANG_BIN_PATH}:${KERNEL_PLATFORM_FOLDER}/prebuilts/kernel-build-tools/linux-x86/bin/:${KERNEL_PLATFORM_FOLDER}/prebuilts/kernel-build-tools/linux_musl-x86/bin/"
        
        if [ -n "${RUSTC_BIN_PATH:-}" ]; then
          export PATH="${BASE_PATH}:${RUSTC_BIN_PATH}:${PATH}"
          export RUSTC="$RUSTC_BIN_PATH/rustc"
          if [ "${{ env.OP_RUST_BUILD}}" = "true" ]; then
            export LIBCLANG_PATH="$CLANG_BIN_PATH/../lib"
            export BINDGEN="bindgen"
          fi
        else
          export PATH="${BASE_PATH}:${PATH}"
        fi
        
        if [ "${{ inputs.clean }}" = "true" ]; then
          echo "ðŸ§¹ Clean build mode - ccache disabled"
          export CCACHE_DISABLE=1
        else
          echo "ðŸš€ ccache-accelerated build"
        fi
        
        OUT=out
        mkdir -p "$OUT"
        
        echo "============================================"
        echo "ðŸ” Compiler & ccache Verification"
        echo "============================================"
        echo "PATH: ${PATH:0:200}..."
        echo "which clang: $(which clang)"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "CCACHE_BASEDIR: ${CCACHE_BASEDIR:-not set}"
        echo ""
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          echo "ccache wrapper test:"
          clang --version 2>&1 | head -n1 || true
          echo ""
          echo "ccache configuration:"
          ccache -p | grep -E "(compression|direct_mode|readonly_direct|depend|sloppiness)" || true
          echo ""
          echo "ccache pre-build status:"
          ccache -s | head -n 20
        else
          echo "âš ï¸ Clean build - ccache bypassed"
        fi
        echo "============================================"
        
        make O="$OUT" gki_defconfig
        
        LOCAL_LOCALVERSION="${CUSTOM_LOCALVERSION:--OP-WILD}"
        if [ -n "${LOCAL_LOCALVERSION:-}" ]; then
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${LOCAL_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
          sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion
        fi
        
        if [ "${{ inputs.optimize_level }}" = "O3" ]; then
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O3"
        else
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O2"
        fi
        
        case "${{ env.OP_LTO}}" in
          "none")
            scripts/config --file "$OUT/.config" -e LTO_CLANG
            scripts/config --file "$OUT/.config" -e LTO_CLANG_NONE
            scripts/config --file "$OUT/.config" -d LTO_CLANG_THIN
            scripts/config --file "$OUT/.config" -d LTO_CLANG_FULL
            ;;
          "thin")
            scripts/config --file "$OUT/.config" -e LTO_CLANG
            scripts/config --file "$OUT/.config" -e LTO_CLANG_THIN
            scripts/config --file "$OUT/.config" -d LTO_CLANG_NONE
            scripts/config --file "$OUT/.config" -d LTO_CLANG_FULL
            ;;
          "full")
            scripts/config --file "$OUT/.config" -e LTO_CLANG
            scripts/config --file "$OUT/.config" -e LTO_CLANG_FULL
            scripts/config --file "$OUT/.config" -d LTO_CLANG_NONE
            scripts/config --file "$OUT/.config" -d LTO_CLANG_THIN
            ;;
          *)
            echo "::error::Unsupported LTO option: ${{ env.OP_LTO}}"
            exit 1
            ;;
        esac
        
        
        make O="$OUT" olddefconfig
        
        KCFLAGS="$KCFLAGS -Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}"
        KCPPFLAGS="$KCPPFLAGS -DCONFIG_OPTIMIZE_INLINING"
        
        echo "============================================"
        echo "ðŸ”§ Build Configuration"
        echo "============================================"
        echo "Device: ${OP_MODEL}"
        echo "Kernel: ${KERNEL_FULL_VER}"
        echo "Threads: $(nproc --all)"
        echo "Optimization: ${{ inputs.optimize_level }}"
        echo "KCFLAGS: ${KCFLAGS:0:150}..."
        echo "KCPPFLAGS: ${KCPPFLAGS:0:150}..."
        echo "Timestamp: $KBUILD_BUILD_TIMESTAMP"
        echo "Workspace: $WORKSPACE"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          echo "ccache: ENABLED"
          echo "  Dir: $CCACHE_DIR"
          echo "  Base: $CCACHE_BASEDIR"
          echo "  Max size: $CCACHE_MAXSIZE"
          echo "  Compression: zstd level 3"
          echo "  Features: readonly_direct, file_clone, inode_cache, depend"
        else
          echo "ccache: DISABLED (clean build)"
        fi
        echo "============================================"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          if [ ! -d "$CCACHE_DIR" ] || [ -z "$(find "$CCACHE_DIR" -type f 2>/dev/null | head -n1)" ]; then
            echo "ðŸ”¥ Priming cache with header preprocessing..."
            make -C "$COMMON_KERNEL_FOLDER" O="$OUT" headers_install prepare 2>&1 | head -n 20 || true
            echo ""
          fi
        fi
        
        BUILD_START=$(date +%s)
        set -o pipefail
        
        make -j"$(nproc --all)" O="$OUT" KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS" 2>&1 | tee build.log
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "BUILD_START=$BUILD_START" >> "$GITHUB_ENV"
        echo "BUILD_END=$BUILD_END" >> "$GITHUB_ENV"
        echo "BUILD_TIME=$BUILD_TIME" >> "$GITHUB_ENV"
        
        IMG="$OUT/arch/arm64/boot/Image"
        if [ ! -f "$IMG" ]; then
          echo "::error::Kernel Image missing"
          echo "::group::Last 100 lines of build log"
          tail -n 100 build.log || echo "Build log not available"
          echo "::endgroup::"
          exit 1
        fi
        
        IMG_SIZE=$(stat -c%s "$IMG")
        
        echo "============================================"
        echo "âœ… Build Completed Successfully"
        echo "============================================"
        echo "Duration: $((BUILD_TIME / 60))m $((BUILD_TIME % 60))s"
        echo "Image: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          echo ""
          echo "ðŸ“Š ccache Post-Build Statistics"
          echo "============================================"
          ccache -s
        fi
        echo "============================================"
        echo "::endgroup::"

    - name: ðŸ“Š ccache Post-Build Statistics
      id: ccache_stats
      if: ${{ always() && inputs.clean != 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::ccache final statistics"

        export CCACHE_DIR="${{ env.CCACHE_DIR }}"

        echo "ccache Statistics"
        ccache -s

        STATS="$(ccache -s)"

        CACHEABLE=$(echo "$STATS" | awk '/Cacheable calls:/ {match($0, /[0-9]+/); print substr($0, RSTART, RLENGTH)}' | head -n1)
        HITS=$(echo "$STATS" | awk '/^[[:space:]]*Hits:/ {match($0, /[0-9]+/); print substr($0, RSTART, RLENGTH)}' | head -n1)
        DIRECT=$(echo "$STATS" | awk '/Direct:/ {match($0, /[0-9]+/); print substr($0, RSTART, RLENGTH)}' | head -n1)

        if [ "${CACHEABLE:-0}" -gt 0 ]; then
          HIT_RATE=$(awk -v h="${HITS:-0}" -v c="$CACHEABLE" 'BEGIN{printf "%.1f", (h/c)*100}')
          DIRECT_RATE=$(awk -v d="${DIRECT:-0}" -v c="$CACHEABLE" 'BEGIN{printf "%.1f", (d/c)*100}')
        else
          HIT_RATE="0.0"
          DIRECT_RATE="0.0"
        fi

        echo "hit_rate=${HIT_RATE}%" >> "$GITHUB_OUTPUT"
        echo "direct_rate=${DIRECT_RATE}%" >> "$GITHUB_OUTPUT"

        echo "::endgroup::"

        echo "## ðŸ“Š ccache Statistics" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"
        ccache -s >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"

    - name: Collect Build Stats / Validate Image
      id: collect_stats
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Collect Build stats"
        IMG="$COMMON_KERNEL_FOLDER/out/arch/arm64/boot/Image"
        
        if [ -f "$KERNEL_PLATFORM_FOLDER/out/$OP_ANDROID_VERSION-$OP_KERNEL_VERSION/dist/Image" ]; then
          IMG="$KERNEL_PLATFORM_FOLDER/out/$OP_ANDROID_VERSION-$OP_KERNEL_VERSION/dist/Image"
        elif [ -f "$KERNEL_PLATFORM_FOLDER/bazel-bin/common/kernel_aarch64/Image" ]; then
          IMG="$KERNEL_PLATFORM_FOLDER/bazel-bin/common/kernel_aarch64/Image"
        fi
        
        if [ -f "$COMMON_KERNEL_FOLDER/build.log" ]; then
          WARNINGS_COUNT="$(grep -ciE '\bwarning:' "$COMMON_KERNEL_FOLDER/build.log" || true)"
          [ -n "$WARNINGS_COUNT" ] || WARNINGS_COUNT="0"
        else
          WARNINGS_COUNT="0"
        fi
        
        if [ ! -f "$IMG" ]; then
          echo "::error::Kernel Image not found at: $IMG"
          exit 1
        fi
        
        if ! file "$IMG" | grep -qi 'ARM64'; then
          echo "::error::Image is not ARM64 format"
          file "$IMG"
          exit 1
        fi
        
        IMG_SIZE=$(stat -c %s "$IMG")
        MIN_SIZE=6102400
        if [ "$IMG_SIZE" -lt "$MIN_SIZE" ]; then
          echo "::error::Image size too small: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
          exit 1
        fi
        
        IMG_SHA256=$(sha256sum "$IMG" | awk '{print $1}')
        BUILD_TIME="${BUILD_TIME:-0}"
        
        KERNEL_UNAME=$(strings "$IMG" | grep -E 'Linux version.*#' | tail -n1)
        echo "Kernel Uname: $KERNEL_UNAME"
        echo "KERNEL_UNAME=$KERNEL_UNAME" >> "$GITHUB_ENV"
        
        printf 'warnings_count=%s\n' "$WARNINGS_COUNT" >> "$GITHUB_OUTPUT"
        printf 'image_sha256=%s\n' "$IMG_SHA256" >> "$GITHUB_OUTPUT"
        printf 'build_time=%s\n' "$BUILD_TIME" >> "$GITHUB_OUTPUT"
        
        echo "âœ… Validation passed:"
        echo "   - Warnings: $WARNINGS_COUNT"
        echo "   - Image size: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
        echo "   - SHA256: $IMG_SHA256"
        echo "   - Build time: ${BUILD_TIME}s"
        echo "::endgroup::"

    - name: Create Kernel ZIP
      id: create_zip
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Create kernel ZIP package"
        
        IMAGE_PATH="$COMMON_KERNEL_FOLDER/out/arch/arm64/boot/Image"
        
        if [ -f "$KERNEL_PLATFORM_FOLDER/out/$OP_ANDROID_VERSION-$OP_KERNEL_VERSION/dist/Image" ]; then
          IMAGE_PATH="$KERNEL_PLATFORM_FOLDER/out/$OP_ANDROID_VERSION-$OP_KERNEL_VERSION/dist/Image"
        elif [ -f "$KERNEL_PLATFORM_FOLDER/bazel-bin/common/kernel_aarch64/Image" ]; then
          IMAGE_PATH="$KERNEL_PLATFORM_FOLDER/bazel-bin/common/kernel_aarch64/Image"
        fi
        
        if [ ! -f "$IMAGE_PATH" ]; then
          echo "::error::Built Image not found at: $IMAGE_PATH"
          exit 1
        fi
        
        cp "$IMAGE_PATH" "$AK3_FOLDER/Image"
        cd "$AK3_FOLDER"
        
        if [ "${{ env.OP_SUSFS }}" = true ]; then
          ZIP_NAME="AK3_${OP_MODEL}_${OP_OS_VERSION}_${KERNEL_FULL_VER}_${{ inputs.ksu_type }}_${KSUVER:-unknown}_SuSFS_${SUSVER:-unknown}.zip"
        else
          ZIP_NAME="AK3_${OP_MODEL}_${OP_OS_VERSION}_${KERNEL_FULL_VER}_${{ inputs.ksu_type }}_${KSUVER:-unknown}.zip"
        fi
        mkdir -p "$ARTIFACTS_FOLDER"
        
        echo "Creating flashable ZIP: $ZIP_NAME"
        
        if ! zip -r9 "$ZIP_NAME" ./* \
             -x "*.git*" \
             -x "$ZIP_NAME" \
             -x "README.md" 2>&1 | tee /tmp/zip.log; then
          echo "::error::Failed to create ZIP package"
          exit 1
        fi
        
        mv "$ZIP_NAME" "$ARTIFACTS_FOLDER/"
        
        find "$ARTIFACTS_FOLDER" -maxdepth 1 -type f ! -name "$ZIP_NAME" ! -name "${OP_MODEL}_${OP_OS_VERSION}.txt" -delete
        
        ZIP_SIZE=$(stat -c%s "$ARTIFACTS_FOLDER/$ZIP_NAME")
        ZIP_SHA256=$(sha256sum "$ARTIFACTS_FOLDER/$ZIP_NAME" | awk '{print $1}')
        
        echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"
        echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
        
        echo ""
        echo "âœ… Kernel ZIP created successfully"
        echo "   Name: $ZIP_NAME"
        echo "   Size: $(numfmt --to=iec-i --suffix=B "$ZIP_SIZE")"
        echo "   SHA256: $ZIP_SHA256"
        echo "::endgroup::"

    - name: Final Build Summary
      shell: bash
      run: |
        set -euo pipefail
        
        # Get commit SHAs with fallback
        KSU_SHA="${KSU_COMMIT_SHA:-unknown}"
        SUSFS_SHA="${SUSFS_COMMIT_SHA:-unknown}"
        
        {
          echo "Model: ${{ env.OP_MODEL }}"
          echo "OS Version: ${{ env.OP_OS_VERSION }}"
          echo "Android: ${{ env.ANDROID_VER }}"
          echo "Kernel base: ${{ env.KERNEL_VER }}"
          echo "Kernel full: ${{ env.KERNEL_FULL_VER }}"
          echo "Kernel Uname: ${{ env.KERNEL_UNAME }}"
          echo "Build User: ${{ env.BUILD_USER }}"
          echo "Build Host: ${{ env.BUILD_HOST }}"
          if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
            echo "KSUN Version: ${KSUVER:-unknown}"
            echo "KSUN commit SHA: ${KSU_SHA:-unknown}"
          else
            echo "KSU Version: ${KSUVER:-unknown}"
            echo "KSU commit SHA: ${KSU_SHA:-unknown}"
          fi
          if [ "${{ env.OP_SUSFS }}" = true ]; then
            echo "SUSFS Version: ${SUSVER:-unknown}"
            echo "SUSFS Branch: ${{ env.SUSFS_BRANCH_NAME }}"
            echo "SUSFS commit SHA: $SUSFS_SHA"
          fi
          echo "Optimization: ${{ inputs.optimize_level }}"
          echo "Clean Build: ${{ inputs.clean }}"
          echo ""
          echo "=== OnePlus Features ==="
          echo "BBR: ${{ env.OP_BBR }}"
          echo "BBG: ${{ env.OP_BBG }}"
          echo "Hmbird: ${{ env.OP_HMBIRD }}"
          echo "TTL: ${{ env.OP_TTL }}"
          echo "IP_SET: ${{ env.OP_IP_SET }}"
          echo ""
          echo "Image SHA256: ${{ steps.collect_stats.outputs.image_sha256 }}"
          echo "Compiler: ${CLANG_VERSION:-unknown}"
          echo "Warnings Count: ${{ steps.collect_stats.outputs.warnings_count }}"
          echo "Build Time: ${{ steps.collect_stats.outputs.build_time }}s"
          if [ "${{ inputs.clean }}" != "true" ]; then
            echo "ccache Hit Rate: ${{ steps.ccache_stats.outputs.hit_rate }}"
            echo "ccache Direct Rate: ${{ steps.ccache_stats.outputs.direct_rate }}"
          else
            echo "ccache: Disabled (clean build)"
          fi
        } | tee summary.txt
        
        {
          echo "### ðŸŽ¯ Kernel Build Summary"
          echo ""
          echo "| Metric | Value |"
          echo "|--------|-------|"
          echo "| **Model** | ${{ env.OP_MODEL }} |"
          echo "| **OS Version** | ${{ env.OP_OS_VERSION }} |"
          echo "| **Kernel Version** | ${{ steps.save_metadata.outputs.kernel_version }} |"
          echo "| **Kernel Uname** | \`${{ env.KERNEL_UNAME }}\` |"
          echo "| **Build User** | ${{ env.BUILD_USER }} |"
          echo "| **Build Host** | ${{ env.BUILD_HOST }} |"
          if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
            echo "| **KSUN Version** | ${KSUVER:-unknown} |"
          else
            echo "| **KSU Version** | ${KSUVER:-unknown} |"
          fi
          
          if [ "$KSU_SHA" != "unknown" ]; then
            if [ "${{ inputs.ksu_type }}" = "KSUN" ]; then
              echo "| **KSUN Commit** | [\`${KSU_SHA:0:8}\`](https://github.com/KernelSU-Next/KernelSU-Next/commit/$KSU_SHA) |"
            else
              echo "| **KSU Commit** | [\`${KSU_SHA:0:8}\`](https://github.com/tiann/KernelSU/commit/$KSU_SHA) |"
            fi
          else
            echo "| **KSU Commit** | unknown |"
          fi
          
          if [ "${{ env.OP_SUSFS }}" = true ]; then
            echo "| **SUSFS Version** | ${SUSVER:-unknown} |"
            echo "| **SUSFS Branch** | \`${{ env.SUSFS_BRANCH_NAME }}\` |"
            
            if [ "$SUSFS_SHA" != "unknown" ]; then
              echo "| **SUSFS Commit** | [\`${SUSFS_SHA:0:8}\`](https://gitlab.com/simonpunk/susfs4ksu/-/commit/$SUSFS_SHA) |"
            else
              echo "| **SUSFS Commit** | unknown |"
            fi
          fi
          
          echo ""
          echo "### ðŸ”§ OnePlus Features"
          echo ""
          echo "| Feature | Status |"
          echo "|---------|--------|"
          echo "| **BBR** | ${{ env.OP_BBR }} |"
          echo "| **BBG** | ${{ env.OP_BBG }} |"
          echo "| **Hmbird** | ${{ env.OP_HMBIRD }} |"
          echo "| **TTL** | ${{ env.OP_TTL }} |"
          echo "| **IP_SET** | ${{ env.OP_IP_SET }} |"
          
          echo ""
          echo "### ðŸ“Š Build Metrics"
          echo ""
          echo "| Metric | Value |"
          echo "|--------|-------|"
          echo "| **Optimization** | ${{ inputs.optimize_level }} |"
          echo "| **Clean Build** | ${{ inputs.clean }} |"
          echo "| **Build Time** | ${{ steps.collect_stats.outputs.build_time }}s |"
          
          if [ "${{ inputs.clean }}" != "true" ]; then
            echo "| **ccache Hit Rate** | ${{ steps.ccache_stats.outputs.hit_rate }} |"
            echo "| **ccache Direct Rate** | ${{ steps.ccache_stats.outputs.direct_rate }} |"
          fi
          
          echo "| **Image SHA256** | \`${{ steps.collect_stats.outputs.image_sha256 }}\` |"
          echo "| **Warnings** | ${{ steps.collect_stats.outputs.warnings_count }} |"
          echo "| **Compiler** | \`${CLANG_VERSION:-unknown}\` |"
        } >> "$GITHUB_STEP_SUMMARY"

    - name: Upload Artifacts
      if: success() && steps.create_zip.conclusion == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ inputs.ksu_type }}-${{ env.CONFIG }}_${{ env.OP_OS_VERSION }}
        path: ${{ env.ARTIFACTS_FOLDER }}/
        compression-level: 0
        retention-days: 20
