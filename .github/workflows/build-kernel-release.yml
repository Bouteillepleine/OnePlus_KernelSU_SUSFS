name: Kernel Build

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: 'Create a GitHub Release per device?'
        required: true
        type: boolean
        default: false
      KSU_META:
        description: 'SukiSU Ultra branch/custom tag (e.g. susfs-main/⚡Ultra⚡)'
        required: false
        type: string
        default: 'susfs-main/⚡Ultra⚡'
      KPM:
        description: 'Enable KPM patch'
        required: true
        type: boolean
        default: true
      HOOK:
        description: 'Hook type'
        required: true
        type: choice
        default: manual
        options:
          - kprobe
          - manual
          - tracepoint

concurrency:
  group: kernel-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build (${{ matrix.model }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - model: OP13
            soc: sun
            branch: oneplus/sm8750
            manifest: oneplus_13.xml
            android_version: android15
            kernel_version: '6.6'
          - model: OP13r
            soc: pineapple
            branch: oneplus/sm8650
            manifest: oneplus_13r.xml
            android_version: android14
            kernel_version: '6.1'
          - model: OP-ACE-5
            soc: pineapple
            branch: oneplus/sm8650
            manifest: oneplus_ace5.xml
            android_version: android14
            kernel_version: '6.1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Build Kernel
        uses: ./.github/actions/build
        with:
          model: ${{ matrix.model }}
          soc: ${{ matrix.soc }}
          branch: ${{ matrix.branch }}
          manifest: ${{ matrix.manifest }}
          android_version: ${{ matrix.android_version }}
          kernel_version: ${{ matrix.kernel_version }}
          susfs_branch: ''
          KSU_META: ${{ inputs.KSU_META }}
          KPM: ${{ inputs.KPM }}
          HOOK: ${{ inputs.HOOK }}

      - name: Create Release (per-device)
        if: ${{ github.event.inputs.make_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.model }}-${{ matrix.android_version }}-${{ matrix.kernel_version }}-v${{ env.KSU_API_VERSION }}-${{ env.GIT_HASH }}
          name: SukiSU Ultra Kernel for ${{ matrix.model }}
          body: |
            # SukiSU Ultra Kernel Release for ${{ matrix.model }}

            **Kernel Version**: ${{ matrix.kernel_version }}
            **Android Version**: ${{ matrix.android_version }}
            **SukiSU Ultra Version**: ${{ env.KSU_VERSION_FULL }}
            **KSU API Version**: ${{ env.KSU_API_VERSION }}
            **Commit Hash**: ${{ env.GIT_HASH }}
            **KPM Enabled**: ${{ inputs.KPM }}
            **Hook Type**: ${{ inputs.HOOK }}

            ## Features
            - SukiSU Ultra (Magic Mount + SUSFS integration)
            - SUSFS spoof uname / cmdline / bootconfig
            - Open redirect & KSTAT
            - Symbol hiding
            - BBR congestion control & queue disciplines
            - TTL / HL targets

            ## Installation
            1. Flash the AnyKernel3 zip in recovery.
            2. Reboot.

            ## Notes
            - Backup before flashing.
            - Ensure correct device & Android version.
          files: |
            ${{ matrix.model }}/artifacts/AnyKernel3_${{ matrix.model }}_${{ matrix.android_version }}-${{ matrix.kernel_version }}*.zip
            ${{ matrix.model }}/artifacts/*sha256*
          draft: false
          prerelease: false
